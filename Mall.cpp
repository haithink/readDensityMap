#include <iostream>
#include <fstream>
#include <sstream>
#include <string>
#include <vector>

#include "opencv2/opencv.hpp"
#include "features2d.hpp"

using namespace std;
using namespace cv;

extern int thresh;
extern int thresh1;

extern Mat dst;

extern cv::Mat img;

string findFileName(string name);

void showImgMall()
{
	string imgPaths[] = {
		"Mall/test_data/seq_000786",
		"Mall/test_data/seq_001359",
		"Mall/test_data/seq_001341",
		"Mall/test_data/seq_000018",
		"Mall/test_data/seq_001502",
		"Mall/test_data/seq_001244",
		"Mall/test_data/seq_000377",
		"Mall/test_data/seq_001369",
		"Mall/test_data/seq_000559",
		"Mall/test_data/seq_001541",
		"Mall/test_data/seq_001752",
		"Mall/test_data/seq_001436",
		"Mall/test_data/seq_001122",
		"Mall/test_data/seq_000406",
		"Mall/test_data/seq_000800",
		"Mall/test_data/seq_000107",
		"Mall/test_data/seq_000551",
		"Mall/test_data/seq_001040",
		"Mall/test_data/seq_001961",
		"Mall/test_data/seq_000568",
		"Mall/test_data/seq_000788",
		"Mall/test_data/seq_000720",
		"Mall/test_data/seq_001323",
		"Mall/test_data/seq_001834",
		"Mall/test_data/seq_000302",
		"Mall/test_data/seq_000293",
		"Mall/test_data/seq_001327",
		"Mall/test_data/seq_000696",
		"Mall/test_data/seq_000541",
		"Mall/test_data/seq_000024",
		"Mall/test_data/seq_001280",
		"Mall/test_data/seq_000476",
		"Mall/test_data/seq_000208",
		"Mall/test_data/seq_001173",
		"Mall/test_data/seq_001736",
		"Mall/test_data/seq_001377",
		"Mall/test_data/seq_001172",
		"Mall/test_data/seq_001422",
		"Mall/test_data/seq_000701",
		"Mall/test_data/seq_000048",
		"Mall/test_data/seq_001418",
		"Mall/test_data/seq_000504",
		"Mall/test_data/seq_000739",
		"Mall/test_data/seq_001073",
		"Mall/test_data/seq_001808",
		"Mall/test_data/seq_000727",
		"Mall/test_data/seq_001004",
		"Mall/test_data/seq_001820",
		"Mall/test_data/seq_000519",
		"Mall/test_data/seq_001334",
		"Mall/test_data/seq_001677",
		"Mall/test_data/seq_000880",
		"Mall/test_data/seq_000723",
		"Mall/test_data/seq_001724",
		"Mall/test_data/seq_001055",
		"Mall/test_data/seq_000136",
		"Mall/test_data/seq_001131",
		"Mall/test_data/seq_000287",
		"Mall/test_data/seq_001683",
		"Mall/test_data/seq_000803",
		"Mall/test_data/seq_001727",
		"Mall/test_data/seq_001770",
		"Mall/test_data/seq_000968",
		"Mall/test_data/seq_000738",
		"Mall/test_data/seq_000435",
		"Mall/test_data/seq_000924",
		"Mall/test_data/seq_000044",
		"Mall/test_data/seq_001424",
		"Mall/test_data/seq_000225",
		"Mall/test_data/seq_000269",
		"Mall/test_data/seq_001319",
		"Mall/test_data/seq_000607",
		"Mall/test_data/seq_000126",
		"Mall/test_data/seq_001111",
		"Mall/test_data/seq_001616",
		"Mall/test_data/seq_001879",
		"Mall/test_data/seq_001444",
		"Mall/test_data/seq_000106",
		"Mall/test_data/seq_001441",
		"Mall/test_data/seq_000833",
		"Mall/test_data/seq_000291",
		"Mall/test_data/seq_001344",
		"Mall/test_data/seq_000012",
		"Mall/test_data/seq_000891",
		"Mall/test_data/seq_001760",
		"Mall/test_data/seq_001325",
		"Mall/test_data/seq_000064",
		"Mall/test_data/seq_001097",
		"Mall/test_data/seq_000289",
		"Mall/test_data/seq_001980",
		"Mall/test_data/seq_001856",
		"Mall/test_data/seq_000969",
		"Mall/test_data/seq_001515",
		"Mall/test_data/seq_001278",
		"Mall/test_data/seq_000416",
		"Mall/test_data/seq_001050",
		"Mall/test_data/seq_001388",
		"Mall/test_data/seq_001151",
		"Mall/test_data/seq_000458",
		"Mall/test_data/seq_001335",
		"Mall/test_data/seq_000809",
		"Mall/test_data/seq_001103",
		"Mall/test_data/seq_001230",
		"Mall/test_data/seq_001525",
		"Mall/test_data/seq_000873",
		"Mall/test_data/seq_000910",
		"Mall/test_data/seq_000133",
		"Mall/test_data/seq_001884",
		"Mall/test_data/seq_001298",
		"Mall/test_data/seq_000033",
		"Mall/test_data/seq_000082",
		"Mall/test_data/seq_001552",
		"Mall/test_data/seq_000670",
		"Mall/test_data/seq_001287",
		"Mall/test_data/seq_001206",
		"Mall/test_data/seq_000474",
		"Mall/test_data/seq_001927",
		"Mall/test_data/seq_000199",
		"Mall/test_data/seq_001553",
		"Mall/test_data/seq_000811",
		"Mall/test_data/seq_001387",
		"Mall/test_data/seq_000398",
		"Mall/test_data/seq_000088",
		"Mall/test_data/seq_001421",
		"Mall/test_data/seq_001949",
		"Mall/test_data/seq_001382",
		"Mall/test_data/seq_001389",
		"Mall/test_data/seq_000247",
		"Mall/test_data/seq_001082",
		"Mall/test_data/seq_000636",
		"Mall/test_data/seq_000366",
		"Mall/test_data/seq_000325",
		"Mall/test_data/seq_000413",
		"Mall/test_data/seq_000399",
		"Mall/test_data/seq_001392",
		"Mall/test_data/seq_000120",
		"Mall/test_data/seq_001058",
		"Mall/test_data/seq_001886",
		"Mall/test_data/seq_000445",
		"Mall/test_data/seq_001207",
		"Mall/test_data/seq_001606",
		"Mall/test_data/seq_001708",
		"Mall/test_data/seq_000401",
		"Mall/test_data/seq_000394",
		"Mall/test_data/seq_001431",
		"Mall/test_data/seq_000789",
		"Mall/test_data/seq_000280",
		"Mall/test_data/seq_000116",
		"Mall/test_data/seq_001570",
		"Mall/test_data/seq_001957",
		"Mall/test_data/seq_001758",
		"Mall/test_data/seq_001801",
		"Mall/test_data/seq_001940",
		"Mall/test_data/seq_000721",
		"Mall/test_data/seq_001667",
		"Mall/test_data/seq_001637",
		"Mall/test_data/seq_001699",
		"Mall/test_data/seq_000931",
		"Mall/test_data/seq_000227",
		"Mall/test_data/seq_001393",
		"Mall/test_data/seq_001433",
		"Mall/test_data/seq_000484",
		"Mall/test_data/seq_001843",
		"Mall/test_data/seq_000627",
		"Mall/test_data/seq_000798",
		"Mall/test_data/seq_000446",
		"Mall/test_data/seq_000750",
		"Mall/test_data/seq_000451",
		"Mall/test_data/seq_000442",
		"Mall/test_data/seq_000708",
		"Mall/test_data/seq_000041",
		"Mall/test_data/seq_000616",
		"Mall/test_data/seq_001329",
		"Mall/test_data/seq_001903",
		"Mall/test_data/seq_001075",
		"Mall/test_data/seq_001571",
		"Mall/test_data/seq_000315",
		"Mall/test_data/seq_001826",
		"Mall/test_data/seq_001763",
		"Mall/test_data/seq_000466",
		"Mall/test_data/seq_001485",
		"Mall/test_data/seq_001099",
		"Mall/test_data/seq_001469",
		"Mall/test_data/seq_000588",
		"Mall/test_data/seq_001336",
		"Mall/test_data/seq_001520",
		"Mall/test_data/seq_001731",
		"Mall/test_data/seq_001932",
		"Mall/test_data/seq_001751",
		"Mall/test_data/seq_000172",
		"Mall/test_data/seq_001882",
		"Mall/test_data/seq_001842",
		"Mall/test_data/seq_001226",
		"Mall/test_data/seq_000671",
		"Mall/test_data/seq_001374",
		"Mall/test_data/seq_001086",
		"Mall/test_data/seq_001284",
		"Mall/test_data/seq_001355",
		"Mall/test_data/seq_001917",
		"Mall/test_data/seq_001143",
		"Mall/test_data/seq_000858",
		"Mall/test_data/seq_001580",
		"Mall/test_data/seq_000901",
		"Mall/test_data/seq_000615",
		"Mall/test_data/seq_001296",
		"Mall/test_data/seq_001698",
		"Mall/test_data/seq_000197",
		"Mall/test_data/seq_000648",
		"Mall/test_data/seq_001858",
		"Mall/test_data/seq_000308",
		"Mall/test_data/seq_001026",
		"Mall/test_data/seq_000801",
		"Mall/test_data/seq_000558",
		"Mall/test_data/seq_001164",
		"Mall/test_data/seq_001219",
		"Mall/test_data/seq_000028",
		"Mall/test_data/seq_000507",
		"Mall/test_data/seq_000540",
		"Mall/test_data/seq_001713",
		"Mall/test_data/seq_000006",
		"Mall/test_data/seq_001235",
		"Mall/test_data/seq_000262",
		"Mall/test_data/seq_001935",
		"Mall/test_data/seq_000590",
		"Mall/test_data/seq_000411",
		"Mall/test_data/seq_000492",
		"Mall/test_data/seq_001761",
		"Mall/test_data/seq_001852",
		"Mall/test_data/seq_001517",
		"Mall/test_data/seq_001312",
		"Mall/test_data/seq_001035",
		"Mall/test_data/seq_000613",
		"Mall/test_data/seq_001181",
		"Mall/test_data/seq_000624",
		"Mall/test_data/seq_001095",
		"Mall/test_data/seq_001680",
		"Mall/test_data/seq_001783",
		"Mall/test_data/seq_001682",
		"Mall/test_data/seq_000380",
		"Mall/test_data/seq_000620",
		"Mall/test_data/seq_001306",
		"Mall/test_data/seq_000641",
		"Mall/test_data/seq_001478",
		"Mall/test_data/seq_000263",
		"Mall/test_data/seq_001828",
		"Mall/test_data/seq_000883",
		"Mall/test_data/seq_001098",
		"Mall/test_data/seq_000885",
		"Mall/test_data/seq_000402",
		"Mall/test_data/seq_001313",
		"Mall/test_data/seq_001754",
		"Mall/test_data/seq_000286",
		"Mall/test_data/seq_001833",
		"Mall/test_data/seq_001439",
		"Mall/test_data/seq_001051",
		"Mall/test_data/seq_000478",
		"Mall/test_data/seq_000661",
		"Mall/test_data/seq_000927",
		"Mall/test_data/seq_000916",
		"Mall/test_data/seq_000270",
		"Mall/test_data/seq_001321",
		"Mall/test_data/seq_000853",
		"Mall/test_data/seq_000830",
		"Mall/test_data/seq_000860",
		"Mall/test_data/seq_001395",
		"Mall/test_data/seq_001072",
		"Mall/test_data/seq_001984",
		"Mall/test_data/seq_000561",
		"Mall/test_data/seq_001630",
		"Mall/test_data/seq_001542",
		"Mall/test_data/seq_000072",
		"Mall/test_data/seq_001601",
		"Mall/test_data/seq_001304",
		"Mall/test_data/seq_001183",
		"Mall/test_data/seq_001061",
		"Mall/test_data/seq_000065",
		"Mall/test_data/seq_001586",
		"Mall/test_data/seq_001406",
		"Mall/test_data/seq_001200",
		"Mall/test_data/seq_001877",
		"Mall/test_data/seq_001692",
		"Mall/test_data/seq_001593",
		"Mall/test_data/seq_000758",
		"Mall/test_data/seq_001929",
		"Mall/test_data/seq_001872",
		"Mall/test_data/seq_000987",
		"Mall/test_data/seq_001225",
		"Mall/test_data/seq_000192",
		"Mall/test_data/seq_000089",
		"Mall/test_data/seq_000288",
		"Mall/test_data/seq_001166",
		"Mall/test_data/seq_001074",
		"Mall/test_data/seq_000652",
		"Mall/test_data/seq_000036",
		"Mall/test_data/seq_000093",
		"Mall/test_data/seq_000479",
		"Mall/test_data/seq_001250",
		"Mall/test_data/seq_000846",
		"Mall/test_data/seq_001454",
		"Mall/test_data/seq_001954",
		"Mall/test_data/seq_001592",
		"Mall/test_data/seq_000934",
		"Mall/test_data/seq_001518",
		"Mall/test_data/seq_000735",
		"Mall/test_data/seq_000248",
		"Mall/test_data/seq_000053",
		"Mall/test_data/seq_001084",
		"Mall/test_data/seq_000404",
		"Mall/test_data/seq_001152",
		"Mall/test_data/seq_001091",
		"Mall/test_data/seq_001148",
		"Mall/test_data/seq_001623",
		"Mall/test_data/seq_000680",
		"Mall/test_data/seq_000125",
		"Mall/test_data/seq_001845",
		"Mall/test_data/seq_000489",
		"Mall/test_data/seq_001841",
		"Mall/test_data/seq_001352",
		"Mall/test_data/seq_000688",
		"Mall/test_data/seq_001432",
		"Mall/test_data/seq_000546",
		"Mall/test_data/seq_000431",
		"Mall/test_data/seq_000975",
		"Mall/test_data/seq_001640",
		"Mall/test_data/seq_000118",
		"Mall/test_data/seq_000850",
		"Mall/test_data/seq_001913",
		"Mall/test_data/seq_001651",
		"Mall/test_data/seq_000932",
		"Mall/test_data/seq_001765",
		"Mall/test_data/seq_001455",
		"Mall/test_data/seq_001762",
		"Mall/test_data/seq_001071",
		"Mall/test_data/seq_000205",
		"Mall/test_data/seq_001690",
		"Mall/test_data/seq_000152",
		"Mall/test_data/seq_000697",
		"Mall/test_data/seq_000278",
		"Mall/test_data/seq_000424",
		"Mall/test_data/seq_001733",
		"Mall/test_data/seq_001659",
		"Mall/test_data/seq_000956",
		"Mall/test_data/seq_001909",
		"Mall/test_data/seq_000464",
		"Mall/test_data/seq_000536",
		"Mall/test_data/seq_000795",
		"Mall/test_data/seq_000110",
		"Mall/test_data/seq_000805",
		"Mall/test_data/seq_001416",
		"Mall/test_data/seq_001868",
		"Mall/test_data/seq_000667",
		"Mall/test_data/seq_001989",
		"Mall/test_data/seq_001171",
		"Mall/test_data/seq_000026",
		"Mall/test_data/seq_001236",
		"Mall/test_data/seq_000412",
		"Mall/test_data/seq_000493",
		"Mall/test_data/seq_000103",
		"Mall/test_data/seq_000176",
		"Mall/test_data/seq_000856",
		"Mall/test_data/seq_001127",
		"Mall/test_data/seq_000470",
		"Mall/test_data/seq_001456",
		"Mall/test_data/seq_001079",
		"Mall/test_data/seq_001519",
		"Mall/test_data/seq_001560",
		"Mall/test_data/seq_001648",
		"Mall/test_data/seq_001043",
		"Mall/test_data/seq_000826",
		"Mall/test_data/seq_001462",
		"Mall/test_data/seq_001707",
		"Mall/test_data/seq_000183",
		"Mall/test_data/seq_001899",
		"Mall/test_data/seq_001305",
		"Mall/test_data/seq_001092",
		"Mall/test_data/seq_001835",
		"Mall/test_data/seq_001777",
		"Mall/test_data/seq_001674",
		"Mall/test_data/seq_000340",
		"Mall/test_data/seq_001825",
		"Mall/test_data/seq_001042",
		"Mall/test_data/seq_001865",
		"Mall/test_data/seq_000988",
		"Mall/test_data/seq_000056",
		"Mall/test_data/seq_000598",
		"Mall/test_data/seq_001350",
		"Mall/test_data/seq_000104",
		"Mall/test_data/seq_001129",
		"Mall/test_data/seq_000386",
		"Mall/test_data/seq_001212",
		"Mall/test_data/seq_001036",
		"Mall/test_data/seq_000163",
		"Mall/test_data/seq_001056",
		"Mall/test_data/seq_000682",
		"Mall/test_data/seq_000781",
		"Mall/test_data/seq_000255",
		"Mall/test_data/seq_000372",
		"Mall/test_data/seq_000455",
		"Mall/test_data/seq_001209",
		"Mall/test_data/seq_001794",
		"Mall/test_data/seq_001309",
		"Mall/test_data/seq_000538",
		"Mall/test_data/seq_000052",
		"Mall/test_data/seq_001889",
		"Mall/test_data/seq_000911",
		"Mall/test_data/seq_001644",
		"Mall/test_data/seq_001555",
		"Mall/test_data/seq_000062",
		"Mall/test_data/seq_000429",
		"Mall/test_data/seq_000533",
		"Mall/test_data/seq_000542",
		"Mall/test_data/seq_000252",
		"Mall/test_data/seq_001291",
		"Mall/test_data/seq_000972",
		"Mall/test_data/seq_000961",
		"Mall/test_data/seq_001844",
		"Mall/test_data/seq_001222",
		"Mall/test_data/seq_001781",
		"Mall/test_data/seq_000202",
		"Mall/test_data/seq_001371",
		"Mall/test_data/seq_000963",
		"Mall/test_data/seq_001818",
		"Mall/test_data/seq_001108",
		"Mall/test_data/seq_001237",
		"Mall/test_data/seq_000010",
		"Mall/test_data/seq_001046",
		"Mall/test_data/seq_000646",
		"Mall/test_data/seq_000310",
		"Mall/test_data/seq_001554",
		"Mall/test_data/seq_000985",
		"Mall/test_data/seq_001002",
		"Mall/test_data/seq_000717",
		"Mall/test_data/seq_001193",
		"Mall/test_data/seq_000303",
		"Mall/test_data/seq_000979",
		"Mall/test_data/seq_001590",
		"Mall/test_data/seq_000108",
		"Mall/test_data/seq_001582",
		"Mall/test_data/seq_001045",
		"Mall/test_data/seq_001044",
		"Mall/test_data/seq_000407",
		"Mall/test_data/seq_001031",
		"Mall/test_data/seq_001688",
		"Mall/test_data/seq_001824",
		"Mall/test_data/seq_001223",
		"Mall/test_data/seq_000105",
		"Mall/test_data/seq_001998",
		"Mall/test_data/seq_000025",
		"Mall/test_data/seq_001197",
		"Mall/test_data/seq_000194",
		"Mall/test_data/seq_000433",
		"Mall/test_data/seq_000813",
		"Mall/test_data/seq_000150",
		"Mall/test_data/seq_000323",
		"Mall/test_data/seq_000228",
		"Mall/test_data/seq_001118",
		"Mall/test_data/seq_000011",
		"Mall/test_data/seq_000851",
		"Mall/test_data/seq_000660",
		"Mall/test_data/seq_001910",
		"Mall/test_data/seq_001167",
		"Mall/test_data/seq_000046",
		"Mall/test_data/seq_001847",
		"Mall/test_data/seq_000543",
		"Mall/test_data/seq_001573",
		"Mall/test_data/seq_000388",
		"Mall/test_data/seq_000756",
		"Mall/test_data/seq_000055",
		"Mall/test_data/seq_001562",
		"Mall/test_data/seq_001303",
		"Mall/test_data/seq_001559",
		"Mall/test_data/seq_001958",
		"Mall/test_data/seq_001656",
		"Mall/test_data/seq_000792",
		"Mall/test_data/seq_000067",
		"Mall/test_data/seq_001643",
		"Mall/test_data/seq_000859",
		"Mall/test_data/seq_001067",
		"Mall/test_data/seq_001859",
		"Mall/test_data/seq_001800",
		"Mall/test_data/seq_001499",
		"Mall/test_data/seq_000706",
		"Mall/test_data/seq_001179",
		"Mall/test_data/seq_000161",
		"Mall/test_data/seq_001147",
		"Mall/test_data/seq_001489",
		"Mall/test_data/seq_001229",
		"Mall/test_data/seq_000075",
		"Mall/test_data/seq_001846",
		"Mall/test_data/seq_001969",
		"Mall/test_data/seq_000237",
		"Mall/test_data/seq_000114",
		"Mall/test_data/seq_001855",
		"Mall/test_data/seq_000989",
		"Mall/test_data/seq_000589",
		"Mall/test_data/seq_000719",
		"Mall/test_data/seq_001256",
		"Mall/test_data/seq_000838",
		"Mall/test_data/seq_001930",
		"Mall/test_data/seq_001021",
	};
	std::cout << " cnt is " << sizeof(imgPaths) / sizeof(string) << std::endl;
	int imgCnt = sizeof(imgPaths) / sizeof(string);

	for (int i = 0; i < imgCnt; i++)
	{

		string imgPath = "E:\\DeepLearning\\githubCode\\crowdcount-cascaded-mtl\\outputMall\\density_maps_cmtl_shtechA_204\\";
		string name = imgPath + "output_" + findFileName(imgPaths[i]) + ".png";

		img = cv::imread(name, 0);

		//Mat element = getStructuringElement(MORPH_RECT, Size(5, 5));
		//cv::Mat img2;
		//erode(img, img2, element);
		//img = img2;

		threshold(img, dst, 19, 255, thresh1);

		string imgSrcPaht = "E:\\DataContest\\yuncong\\yuncong_data\\";
		string srcName = imgSrcPaht + imgPaths[i] + ".jpg";

		cv::Mat imgSrc = cv::imread(srcName, 0);

		cv::Mat local;

		int blockSize = 25;
		int constValue = 10;
		//cv::adaptiveThreshold(img, local, 255, CV_ADAPTIVE_THRESH_MEAN_C, CV_THRESH_BINARY_INV, blockSize, constValue);

		//cv::imshow("density", img);

		//namedWindow("threshold二值化灰图");
		//createTrackbar("阈值:", "threshold二值化灰图", &thresh, 255, on_thresh);
		//createTrackbar("type:", "threshold二值化灰图", &thresh1, 4, on_thresh);
		//on_thresh(0, 0);
		//waitKey(0);
		//CV_THRESH_BINARY

		//SimpleBlobDetector detector;
		cv::SimpleBlobDetector::Params params;
		params.minDistBetweenBlobs = 1.0f;
		params.filterByInertia = false;
		params.filterByConvexity = false;
		params.filterByColor = false;
		params.filterByCircularity = false;
		params.filterByArea = true;
		params.minArea = 36.0f;
		params.maxArea = 500.0f;
		Ptr<SimpleBlobDetector> d = SimpleBlobDetector::create(params);

		std::vector<KeyPoint> keypoints;
		d->detect(dst, keypoints);

		Mat im_with_keypoints;
		drawKeypoints(imgSrc, keypoints, im_with_keypoints, Scalar(0, 0, 255), DrawMatchesFlags::DRAW_RICH_KEYPOINTS);

		//std::cout << " head count is " << keypoints.size() << std::endl;
		// Show blobs
		//imshow("keypoints", im_with_keypoints);
		//waitKey(24);

		std::cout << imgPaths[i] << endl;
		std::cout << keypoints.size() << std::endl;

		for (auto x : keypoints)
		{
			auto halfW = x.size / 2;
			std::cout << std::max(x.pt.x - halfW, 0.0f) << " " << std::max(x.pt.y - halfW, 0.0f)
				<< " "
				<< x.size << " " << x.size << " " << "0.5" << std::endl;
		}

	}

}
